name: 下载

on:
  workflow_dispatch:
  schedule:
    - cron: 0 4 * * * 
jobs:
  download_icons:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Create folders
        run: |
          mkdir -p icons
          mkdir -p rules

      - name: Download icons
        run: |
          urls=(
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Proxy.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Airport.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Twitter.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Google_Search.png"
            "https://raw.githubusercontent.com/shindgewongxj/WHATSINStash/main/icon/anthropic.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Telegram.png"
            "https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/softlyx/PikPak.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/GitHub.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Mickey.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Global.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Area.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Cloudflare.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Amazon.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Reject.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/CN.png"
            "https://raw.githubusercontent.com/shindgewongxj/WHATSINStash/main/icon/apple.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Hong_Kong.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Japan.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/United_States.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Singapore.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/ForeignMedia.png"
            "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Download.png"
          )
          for url in "${urls[@]}"; do
            filename=$(basename "$url")
            echo "Downloading $url -> icons/$filename"
            curl -L "$url" -o "icons/$filename" || echo "Failed: $url"
          done

      - name: Download rules
        run: |
          curl -sSL "https://nsfw-small.oisd.nl" | sed -e '/^[![]/d' -e '/^$/d' -e 's/||\(.*\)\^/  - '\''+.\1'\''/g' | sed '1i payload:' > rules/oisd_nsfw_small.yaml
          curl -sSL https:/ruleset.skk.moe/Clash/ip/china_ip.txt -o rules/china_ip.txt && \
          curl -sSL https:/ruleset.skk.moe/Clash/ip/china_ip_ipv6.txt | grep -v -e '^#' -e '^$' >> rules/china_ip.txt
          curl -sSL https://raw.githubusercontent.com/uselibrary/PCDN/main/pcdn.list -o rules/pcdn.txt
          curl -sSL https://raw.githubusercontent.com/sbwml/luci-app-mosdns/v5/luci-app-mosdns/root/etc/mosdns/rule/cloudflare-cidr.txt -o rules/cloudflare-cidr.txt
          curl -sSL https://raw.githubusercontent.com/juewuy/ShellCrash/dev/public/fake_ip_filter.list -o rules/fake_ip_filter.txt
          curl -sSL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global_Domain.yaml -o rules/Global_Domain.yaml

      - name: Download rules (remote URLs)
        run: |
          urls=(

             #LM-Firefly classical
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/Domestic.yaml"
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/Apple.yaml"
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/Microsoft.yaml"
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/PROXY/Facebook.yaml"
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/PROXY/Cloudflare.yaml"
            "https://raw.githubusercontent.com/LM-Firefly/Rules/master/Clash-RuleSet-Classical/Global-Services/YouTube.yaml"

            # Loyalsoldier
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/apple.txt"
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/google.txt"
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt"
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt"
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/telegramcidr.txt"
            "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/clash/ipcidr/fastly.txt"

            # Sereinfy
            "https://raw.githubusercontent.com/Sereinfy/ipranges/main/amazon/cloudfront_ips.txt"
            "akamai_ips|https://raw.githubusercontent.com/Sereinfy/ipranges/main/akamai/ipv4_merged.txt"
            "adblock_lite|https://raw.githubusercontent.com/Sereinfy/Adrules/main/rules/adblockmihomolite.yaml"

            # blackmatrix7
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitter/Twitter_No_Resolve.yaml"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrivateTracker/PrivateTracker_No_Resolve.yaml"

            # Sukka / ruleset.skk.moe
            "https://ruleset.skk.moe/Clash/non_ip/apple_cn.txt"
            "cdn_non_ip|https://ruleset.skk.moe/Clash/non_ip/cdn.txt"
            "cdn_domainset|https://ruleset.skk.moe/Clash/domainset/cdn.txt"

            # DustinWin
            "https://raw.githubusercontent.com/DustinWin/ruleset_geodata/mihomo-ruleset/ai.mrs"
          )

          for item in "${urls[@]}"; do
            if [[ "$item" == *"|"* ]]; then
              # 有自定义名称
              name="${item%%|*}"       # 拿 | 前面的作为文件名
              url="${item#*|}"         # 拿 | 后面的作为 URL
              ext="${url##*.}"         # 自动提取扩展名
              filename="$name.$ext"
            else
              # 直接用 URL 的文件名
              url="$item"
              filename=$(basename "$url")
            fi

            echo "Downloading $url -> rules/$filename"
            curl -L -f -o "rules/$filename" "$url" || echo "Failed: $url"
          done
     
      - name: Download and unzip `mihomo` core
        run: |
          mkdir -p tools
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C tools/
          mv -f tools/CrashCore tools/mihomo

      - name: Generate `mihomo` rule-set (mrs)
        run: |
          chmod +x tools/mihomo
          tools/mihomo convert-ruleset domain yaml rules/oisd_nsfw_small.yaml rules/oisd_nsfw_small.mrs
          tools/mihomo convert-ruleset domain yaml rules/Global_Domain.yaml rules/Global_Domain.mrs
          rm -rf tools/

          
      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add rules
            git add icons
            git commit -m "Automatic update"
            git push
          else
            echo "No changes detected, skipping commit."
          fi
          
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 1
